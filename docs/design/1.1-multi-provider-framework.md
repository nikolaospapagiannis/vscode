# ExAI Multi-Provider Framework Design

## Component Overview

**Component ID:** 1.1  
**Component Name:** Multi-Provider Framework  
**Phase:** Design  
**Risk Level:** Medium  
**Dependencies:** None  
**Metrics:** Number of supported providers  

## 1. Introduction

The Multi-Provider Framework is a core component of the ExAI system that enables seamless integration with multiple AI service providers. It creates an abstraction layer that presents a unified interface to the rest of the application while handling the provider-specific implementations underneath.

### 1.1 Purpose

The framework allows ExAI to:
- Leverage multiple AI providers (OpenAI, Claude, Perplexity, etc.)
- Switch between providers based on availability, cost, or capability
- Provide a consistent experience regardless of the underlying AI service
- Easily extend support to new providers

### 1.2 Scope

The Multi-Provider Framework handles:
- Provider registration and discovery
- Authentication and API key management
- Request formatting and translation
- Response parsing and normalization
- Error handling and recovery
- Load balancing and fallback mechanisms

## 2. Architecture

### 2.1 High-Level Design

```
┌─────────────────────────────────────────────────────────┐
│                    ExAI Application                     │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│               Provider Manager Interface                │
└───────┬─────────────┬────────────────┬─────────────┬────┘
        │             │                │             │
        ▼             ▼                ▼             ▼
┌───────────┐  ┌─────────────┐  ┌────────────┐  ┌──────────┐
│  OpenAI   │  │   Claude    │  │ Perplexity │  │  Custom  │
│  Adapter  │  │   Adapter   │  │  Adapter   │  │  Adapter │
└───────┬───┘  └──────┬──────┘  └─────┬──────┘  └────┬─────┘
        │             │                │             │
        ▼             ▼                ▼             ▼
┌───────────┐  ┌─────────────┐  ┌────────────┐  ┌──────────┐
│  OpenAI   │  │   Claude    │  │ Perplexity │  │  Custom  │
│   API     │  │    API      │  │    API     │  │   API    │
└───────────┘  └─────────────┘  └────────────┘  └──────────┘
```

### 2.2 Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Multi-Provider Framework                         │
│                                                                         │
│  ┌───────────────────────┐      ┌────────────────────────────────────┐  │
│  │                       │      │                                    │  │
│  │    Provider Manager   │◄────►│     Provider Registry              │  │
│  │                       │      │                                    │  │
│  └───────────┬───────────┘      └────────────────────────────────────┘  │
│              │                                                          │
│              ▼                                                          │
│  ┌───────────────────────┐      ┌────────────────────────────────────┐  │
│  │                       │      │                                    │  │
│  │   Provider Interface  │◄────►│     Configuration Manager          │  │
│  │                       │      │                                    │  │
│  └───────────┬───────────┘      └────────────────────────────────────┘  │
│              │                                                          │
│              ▼                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │                          Provider Adapters                        │  │
│  │                                                                   │  │
│  │   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐   │  │
│  │   │           │   │           │   │           │   │           │   │  │
│  │   │  OpenAI   │   │  Claude   │   │Perplexity │   │  Custom   │   │  │
│  │   │  Adapter  │   │  Adapter  │   │  Adapter  │   │  Adapter  │   │  │
│  │   │           │   │           │   │           │   │           │   │  │
│  │   └───────────┘   └───────────┘   └───────────┘   └───────────┘   │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. Core Components

### 3.1 Provider Manager

The Provider Manager is the main entry point for the Multi-Provider Framework. It handles:

- Initialization of the framework
- Selection of appropriate providers based on request requirements
- Load balancing and fallback strategies
- State management for provider usage

### 3.2 Provider Registry

The Provider Registry maintains a catalog of all available providers. It handles:

- Provider registration and deregistration
- Provider discovery
- Provider capability advertising
- Provider status tracking

### 3.3 Provider Interface

The Provider Interface defines the contract that all provider adapters must implement. It includes:

- Standard request methods
- Response formats
- Error handling patterns
- Capability declarations

### 3.4 Configuration Manager

The Configuration Manager handles:

- Reading provider configurations from settings
- Managing API keys and credentials
- Setting provider preferences
- Configuration validation

### 3.5 Provider Adapters

Provider Adapters implement the Provider Interface for specific AI services. Each adapter:

- Translates standard requests to provider-specific formats
- Handles provider-specific authentication
- Normalizes responses to standard formats
- Implements provider-specific rate limits and error handling

## 4. Interface Definitions

### 4.1 Provider Interface

```typescript
interface AIProvider {
  // Provider identification
  id: string;
  name: string;
  version: string;
  
  // Capability advertising
  capabilities: ProviderCapabilities;
  
  // Authentication
  authenticate(): Promise<boolean>;
  isAuthenticated(): boolean;
  
  // Core operations
  generateCompletion(prompt: string, options: CompletionOptions): Promise<CompletionResult>;
  generateChat(messages: ChatMessage[], options: ChatOptions): Promise<ChatResult>;
  embedText(text: string, options: EmbeddingOptions): Promise<EmbeddingResult>;
  
  // Advanced operations (optional)
  analyzeCode?(code: string, options: CodeAnalysisOptions): Promise<CodeAnalysisResult>;
  generateImage?(prompt: string, options: ImageGenerationOptions): Promise<ImageGenerationResult>;
  analyzeImage?(imageData: Buffer, options: ImageAnalysisOptions): Promise<ImageAnalysisResult>;
  
  // Cost estimation
  estimateTokenUsage(text: string): number;
  estimateCost(request: AIRequest): number;
  
  // Rate limiting and quota management
  getRateLimit(): RateLimitInfo;
  getRemainingQuota(): QuotaInfo;
}

interface ProviderCapabilities {
  supportsCompletion: boolean;
  supportsChat: boolean;
  supportsEmbeddings: boolean;
  supportsCodeAnalysis: boolean;
  supportsImageGeneration: boolean;
  supportsImageAnalysis: boolean;
  contextWindowSize: number;
  maxTokens: number;
  supportedModels: string[];
}
```

### 4.2 Provider Manager Interface

```typescript
interface ProviderManager {
  // Provider management
  registerProvider(provider: AIProvider): void;
  unregisterProvider(providerId: string): void;
  getProvider(providerId: string): AIProvider | undefined;
  getAllProviders(): AIProvider[];
  
  // Provider selection
  getDefaultProvider(): AIProvider;
  getBestProviderForTask(task: AITask, requirements: TaskRequirements): AIProvider;
  
  // Operations
  executeWithProvider<T>(providerId: string, operation: (provider: AIProvider) => Promise<T>): Promise<T>;
  executeWithFallback<T>(operation: (provider: AIProvider) => Promise<T>, requirements: TaskRequirements): Promise<T>;
}
```

### 4.3 Configuration Manager Interface

```typescript
interface ConfigurationManager {
  // Configuration access
  getProviderConfiguration(providerId: string): ProviderConfiguration;
  updateProviderConfiguration(providerId: string, config: Partial<ProviderConfiguration>): void;
  
  // API key management
  getApiKey(providerId: string): Promise<string | undefined>;
  setApiKey(providerId: string, apiKey: string): Promise<void>;
  
  // Provider preferences
  getProviderPreferences(): ProviderPreferences;
  setProviderPreferences(preferences: ProviderPreferences): void;
}
```

## 5. Provider Implementation Details

### 5.1 OpenAI Provider Adapter

- Supports GPT-4 and newer models
- Handles OpenAI API authentication
- Implements token window management
- Translates between ExAI request formats and OpenAI API formats

### 5.2 Claude Provider Adapter

- Supports Claude and Claude Instant models
- Handles Anthropic API authentication
- Translates between ExAI request formats and Anthropic API formats
- Implements Claude-specific prompt formatting

### 5.3 Perplexity Provider Adapter

- Supports Perplexity models
- Handles Perplexity API authentication
- Translates between ExAI request formats and Perplexity API formats

### 5.4 GitHub Copilot Provider Adapter

- Integrates with GitHub Copilot API
- Handles GitHub authentication
- Focuses on code completion and explanation capabilities

## 6. Provider Selection and Fallback Strategy

The framework will use a multi-faceted approach to select providers:

1. **User Preference**: If the user has specified a preferred provider, use it
2. **Task Requirements**: Select based on required capabilities (e.g., code analysis, image generation)
3. **Cost Optimization**: Select the most cost-effective provider that meets requirements
4. **Performance**: Use historical performance data to select fast, reliable providers
5. **Load Balancing**: Distribute load across providers when multiple are suitable
6. **Fallback Chain**: Define fallback sequence when primary provider fails

## 7. Authentication and Security

The framework will implement secure credential handling:

1. **Secure Storage**: Use VS Code's SecretStorage API for API keys
2. **Minimal Scope**: Request only necessary permissions
3. **Token Refresh**: Handle token expiration and refresh flows
4. **Auth Providers**: Leverage VS Code authentication providers where possible
5. **Credential Isolation**: Keep credentials separate for each provider

## 8. Configuration Schema

```typescript
interface ProviderConfiguration {
  enabled: boolean;
  apiKey?: string;
  organizationId?: string;
  baseUrl?: string;
  models: {
    default: string;
    completion?: string;
    chat?: string;
    embedding?: string;
    codeAnalysis?: string;
  };
  rateLimit: {
    maxRequestsPerMinute: number;
    maxTokensPerDay: number;
  };
  costSettings: {
    maxCostPerRequest: number;
    maxCostPerDay: number;
  };
}

interface ProviderPreferences {
  defaultProvider: string;
  providerPriority: string[];
  fallbackStrategy: 'sequential' | 'capability-based' | 'cost-based';
  costSensitivity: 'low' | 'medium' | 'high';
  performancePriority: 'speed' | 'quality' | 'balanced';
}
```

## 9. Implementation Plan

1. **Phase 1: Core Framework**
   - Implement Provider Interface and base adapters
   - Create Provider Manager and Registry
   - Develop Configuration Manager

2. **Phase 2: Primary Providers**
   - Implement OpenAI Provider
   - Implement Claude Provider
   - Implement Perplexity Provider

3. **Phase 3: Advanced Features**
   - Implement provider selection logic
   - Add fallback strategies
   - Develop cost estimation and tracking

4. **Phase 4: Extension Points**
   - Create custom provider extension API
   - Add provider capability discovery
   - Implement provider-specific optimization

## 10. Risk Assessment and Mitigation

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| API Changes | High | Medium | Version detection, abstraction layer, automated tests |
| Rate Limiting | Medium | High | Queue system, backoff strategies, request distribution |
| Authentication Failures | High | Medium | Credential validation, refresh mechanisms, clear error messages |
| Inconsistent Results | Medium | Medium | Response normalization, quality metrics, fallback providers |
| Cost Overruns | High | Low | Budget limits, usage tracking, cost estimates |
| Provider Downtime | High | Low | Health checks, automatic failover, caching mechanisms |

## 11. Performance Considerations

- **Caching**: Cache responses for identical or similar requests
- **Connection Pooling**: Maintain persistent connections to providers
- **Batch Processing**: Combine multiple small requests where possible
- **Parallel Operations**: Execute non-dependent operations in parallel
- **Progressive Enhancement**: Start with fast responses and enhance as needed

## 12. Testing Strategy

- **Unit Tests**: Test individual provider adapters and framework components
- **Integration Tests**: Test provider integration with mock APIs
- **End-to-End Tests**: Test complete flows with real provider APIs
- **Regression Tests**: Verify fixes for provider-specific issues
- **Performance Tests**: Measure response times and resource usage
- **Chaos Testing**: Test with simulated provider failures and API errors

## SELF-CHECK

- [x] Framework design supports multiple AI providers as specified
- [x] Architecture is extensible to accommodate future providers
- [x] Interface definitions are comprehensive and consistent
- [x] Provider adapters are clearly defined for each required service
- [x] Authentication and security concerns are addressed
- [x] Configuration approach is flexible and secure
- [x] Provider selection strategy is well-defined
- [x] Fallback mechanisms are in place for reliability
- [x] Implementation plan is phased and practical
- [x] Risk assessment includes mitigation strategies
- [x] Performance considerations are documented
- [x] Testing strategy covers all aspects of the framework